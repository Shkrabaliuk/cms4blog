<?php
// install_search.php

// =========================================================
// 1. –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø –ê–í–¢–û–ó–ê–í–ê–ù–¢–ê–ñ–£–í–ê–ß–ê
// =========================================================

// –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —à–ª—è—Ö, —è–∫–∏–π –≤–∏ –≤–∫–∞–∑–∞–ª–∏: config/autoload.php
$loaderPath = __DIR__ . '/config/autoload.php';

if (!file_exists($loaderPath)) {
    die("‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–µ –º–æ–∂—É –∑–Ω–∞–π—Ç–∏ —Ñ–∞–π–ª –∞–≤—Ç–æ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞ —à–ª—è—Ö–æ–º: <b>$loaderPath</b><br>–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ —ñ—Å–Ω—É—î –ø–∞–ø–∫–∞ config —ñ —Ñ–∞–π–ª autoload.php —É –Ω—ñ–π.");
}

require_once $loaderPath;

use S2\Rose\Storage\Database\PdoStorage;
use S2\Rose\Storage\Database\MysqlRepository;

// =========================================================
// 2. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ë–ê–ó–ò –î–ê–ù–ò–•
// =========================================================

$host = '127.0.0.1';
$db   = 'logos_db';
$user = 'root';     // <-- –í–ê–® –õ–û–ì–Ü–ù (–∑–∞–∑–≤–∏—á–∞–π root)
$pass = '';         // <-- –í–ê–® –ü–ê–†–û–õ–¨ (—è–∫—â–æ —î)
$charset = 'utf8mb4';

$dsn = "mysql:host=$host;dbname=$db;charset=$charset";
$opt = [
    PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    PDO::ATTR_EMULATE_PREPARES   => false,
];

try {
    // –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ MySQL
    $pdo = new PDO($dsn, $user, $pass, $opt);
    echo "‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö —É—Å–ø—ñ—à–Ω–µ.<br>";

    // =========================================================
    // 3. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ü–û–®–£–ö–û–í–û–ì–û –î–í–ò–ì–£–ù–ê (ROSE)
    // =========================================================

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Å–ø—Ä–∞—Ü—é–≤–∞–≤ –∞–≤—Ç–æ–∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á
    if (!class_exists('S2\Rose\Storage\Database\PdoStorage')) {
        throw new Exception("–ö–ª–∞—Å PdoStorage –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –ª–µ–∂–∞—Ç—å —Ñ–∞–π–ª–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –≤ –ø–∞–ø—Ü—ñ <code>assets/libs/rose/</code>");
    }

    // –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç —Å—Ö–æ–≤–∏—â–∞ –∑ –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º —Ç–∞–±–ª–∏—Ü—å 'rose_'
    $storage = new PdoStorage($pdo, 'rose_');
    $repository = new MysqlRepository($storage);

    // =========================================================
    // 4. –ú–ê–ì–Ü–Ø: –°–¢–í–û–†–ï–ù–ù–Ø –¢–ê–ë–õ–ò–¶–¨
    // =========================================================
    
    echo "‚è≥ –í–∏–∫–æ–Ω—É—é –∫–æ–º–∞–Ω–¥—É erase() –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ç–∞–±–ª–∏—Ü—å...<br>";
    
    // –¶—è –∫–æ–º–∞–Ω–¥–∞ –≤–∏–¥–∞–ª—è—î –∫—Ä–∏–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ —ñ —Å—Ç–≤–æ—Ä—é—î –ø—Ä–∞–≤–∏–ª—å–Ω—ñ
    $repository->erase();
    
    echo "<h2 style='color:green'>üéâ –£—Å–ø—ñ—Ö!</h2>";
    echo "–¢–∞–±–ª–∏—Ü—ñ –¥–ª—è –ø–æ—à—É–∫—É —Å—Ç–≤–æ—Ä–µ–Ω—ñ. –ü–æ–º–∏–ª–∫–∞ <i>'Call S2\Rose... erase() first'</i> –º–∞—î –∑–Ω–∏–∫–Ω—É—Ç–∏.<br>";
    echo "–¢–µ–ø–µ—Ä –≤–∏–¥–∞–ª—ñ—Ç—å —Ü–µ–π —Ñ–∞–π–ª (install_search.php) —ñ –æ–Ω–æ–≤—ñ—Ç—å –≥–æ–ª–æ–≤–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É.";

} catch (\PDOException $e) {
    die("<h3 style='color:red'>‚ùå –ü–æ–º–∏–ª–∫–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö:</h3>" . $e->getMessage());
} catch (\Exception $e) {
    die("<h3 style='color:red'>‚ùå –ü–æ–º–∏–ª–∫–∞:</h3>" . $e->getMessage());
}