<?php
require_once 'includes/db.php';
require_once 'includes/functions.php';

$search = $_GET['search'] ?? '';
$page = max(1, intval($_GET['page'] ?? 1));

$posts = get_posts($search, 'DESC', $page);
$total = get_total_posts($search);
$per_page = (int)get_setting('posts_per_page', 10);
$total_pages = ceil($total / $per_page);

$pageTitle = $search ? "Пошук: $search" : "";
require 'includes/templates/header.php';
?>

<?php if (count($posts) > 0): ?>
    <?php foreach ($posts as $post): ?>
    <article class="post">
        <h2><a href="/post.php?id=<?= $post['id'] ?>"><?= htmlspecialchars($post['title']) ?></a></h2>
        <div class="post-meta">
            <i class="fa-regular fa-clock"></i> <?= time_ago($post['created_at']) ?>
            <?php if (!empty($post['tags'])): ?>
                <?php foreach (parse_tags($post['tags']) as $tag): ?>
                    · <a href="/tags.php?tag=<?= urlencode($tag) ?>"><i class="fa-solid fa-tag"></i> <?= htmlspecialchars($tag) ?></a>
                <?php endforeach; ?>
            <?php endif; ?>
            <?php if (is_admin()): ?>
                · <a href="/admin/post-editor.php?id=<?= $post['id'] ?>"><i class="fa-solid fa-pen-to-square"></i> Редагувати</a>
            <?php endif; ?>
        </div>
        <div class="post-content">
            <?= markdown_excerpt($post['content'], 300) ?>
        </div>
    </article>
    <?php endforeach; ?>

    <?php if ($total_pages > 1): ?>
    <div class="pagination">
        <?php if ($page > 1): ?>
            <a href="?<?= $search ? 'search=' . urlencode($search) . '&' : '' ?>page=<?= $page - 1 ?>"><i class="fa-solid fa-chevron-left"></i> Попередня</a>
        <?php endif; ?>
        <span>Сторінка <?= $page ?> з <?= $total_pages ?></span>
        <?php if ($page < $total_pages): ?>
            <a href="?<?= $search ? 'search=' . urlencode($search) . '&' : '' ?>page=<?= $page + 1 ?>">Наступна <i class="fa-solid fa-chevron-right"></i></a>
        <?php endif; ?>
    </div>
    <?php endif; ?>
<?php else: ?>
    <div class="empty-state">
        <?php if ($search): ?>
            <p>Нічого не знайдено за запитом «<?= htmlspecialchars($search) ?>»</p>
            <p><a href="/index.php">Показати всі пости</a></p>
        <?php else: ?>
            <h2>Блог створено</h2>
            <p>Поки що немає постів. <a href="/admin/post-editor.php">Створіть перший пост</a></p>
        <?php endif; ?>
    </div>
<?php endif; ?>

<?php require 'includes/templates/footer.php'; ?>
